digraph pr_review {
    graph [
        goal="Review a pull request with parallel specialist reviewers, adversarial critique, and interactive synthesis",
        label="Adversarial PR Review Pipeline",
        model_stylesheet="
            *            { llm_model: worker; llm_provider: anthropic; }
            #synthesize  { llm_model: smart; }
            #critic      { llm_model: smart; }
        "
    ]

    node [shape=box]

    // ── lifecycle ──────────────────────────────────────────────
    start [shape=Mdiamond, label="Start"]
    exit  [shape=Msquare,  label="Done"]

    // ── tool handler: fetch diff ────────────────────────────────
    get_diff [shape=parallelogram, label="Get Diff", tool_command="git diff HEAD~1"]

    // ── parallel fan-out / fan-in ─────────────────────────────
    fan_out [shape=component,     label="Fan Out Reviews", error_policy="continue"]
    fan_in  [shape=tripleoctagon, label="Collect Reviews", join_policy="wait_all"]

    // ── specialist reviewers ────────────────────────────────────
    security     [label="Security Review",      agent="security-reviewer",      class="critic"]
    architecture [label="Architecture Review",  agent="architecture-reviewer",  class="critic"]

    // ── adversarial critic ──────────────────────────────────────
    critic [label="Adversarial Critic", agent="review-critic", goal_gate=true]

    // ── conditional gate after critic ───────────────────────────
    gate [shape=diamond, label="Critic Gate"]

    // ── interactive synthesis ────────────────────────────────────
    synthesize [label="Synthesize Reviews", agent="synthesizer", "agent.mode"="interactive"]

    // ── human approval gate ─────────────────────────────────────
    approval [shape=hexagon, label="Review the synthesis", "human.default_choice"="a", timeout="900s"]

    // ── rework node (if human rejects synthesis) ────────────────
    rework [label="Revise Synthesis", agent="synthesizer", prompt="Revise the review synthesis based on the feedback provided. Address the concerns raised and produce an updated verdict."]

    // ── edges ───────────────────────────────────────────────────
    start -> get_diff -> fan_out

    fan_out -> security
    fan_out -> architecture

    security     -> fan_in
    architecture -> fan_in

    fan_in -> critic -> gate

    gate -> fan_out   [condition="context.critic_verdict=insufficient", max_visits=3]
    gate -> synthesize

    synthesize -> approval

    approval -> exit   [label="[A] Approve"]
    approval -> rework [label="[R] Revise"]
    rework   -> approval
}
